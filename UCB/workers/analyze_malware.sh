#!/bin/bash
#
# analyze_malware.sh - Scan USB device for malware
#
# WORKER_QUESTION=Full analysis?
# WORKER_ORDER=10
# WORKER_DESCRIPTION=Scan USB for malware using ClamAV
#

# Configuration
SCAN_LOG="/var/log/usb_malware_scan.log"

# Color codes for terminal output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to display on LCD (disabled - handled by main app)
display_on_lcd() {
    # LCD updates handled by main Python application
    return 0
}

# Function to log with timestamp
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$SCAN_LOG"
}

# Check if device parameter is provided
if [ -z "$1" ]; then
    echo "Usage: $0 <device>"
    echo "Example: $0 sda"
    exit 1
fi

DEVICE=$1
MOUNT_POINT="/media/usb_scan_${DEVICE}"

echo -e "${YELLOW}=== Malware Analysis Started ===${NC}"
log_message "Starting malware scan for /dev/$DEVICE"

# Display scanning message
display_on_lcd "Scanning..." "Please wait"

# Check if ClamAV is installed
if ! command -v clamscan &> /dev/null; then
    echo -e "${RED}ClamAV is not installed!${NC}"
    echo "Installing ClamAV..."
    display_on_lcd "Installing" "Antivirus..."
    
    sudo apt-get update -qq
    sudo apt-get install -y clamav clamav-daemon
    
    echo "Updating virus definitions..."
    display_on_lcd "Updating" "Definitions..."
    sudo systemctl stop clamav-freshclam
    sudo freshclam
    sudo systemctl start clamav-freshclam
fi

# Create mount point if it doesn't exist
sudo mkdir -p "$MOUNT_POINT"

# Try to mount the device
echo "Mounting /dev/${DEVICE}1 to $MOUNT_POINT"
if sudo mount "/dev/${DEVICE}1" "$MOUNT_POINT" 2>/dev/null; then
    log_message "Device mounted successfully at $MOUNT_POINT"
    
    # Count files
    display_on_lcd "Counting files" "Please wait..."
    FILE_COUNT=$(sudo find "$MOUNT_POINT" -type f 2>/dev/null | wc -l)
    echo -e "${GREEN}Found $FILE_COUNT files to scan${NC}"
    log_message "Found $FILE_COUNT files to scan"
    
    # Display file count
    display_on_lcd "Files found:" "$FILE_COUNT"
    sleep 2
    
    # Start scanning with real-time progress
    display_on_lcd "Scanning..." "0%"
    echo -e "${YELLOW}Starting virus scan...${NC}"
    log_message "Starting ClamAV scan"
    
    # Create temporary files
    TEMP_SCAN_OUTPUT="/tmp/clamscan_output_$$"
    TEMP_SCAN_LOG="/tmp/clamscan_log_$$"
    TEMP_INFECTED_FILES="/tmp/infected_files_$$"
    
    # Run ClamAV scan with verbose output in background
    (sudo clamscan -r -v --stdout "$MOUNT_POINT" 2>&1 | tee "$TEMP_SCAN_LOG" > "$TEMP_SCAN_OUTPUT") &
    CLAMSCAN_PID=$!
    
    # Monitor progress by counting scanned files in real-time
    SCANNED_COUNT=0
    LAST_PERCENTAGE=-1
    
    while kill -0 $CLAMSCAN_PID 2>/dev/null; do
        # Count lines that indicate a file was scanned
        if [ -f "$TEMP_SCAN_LOG" ]; then
            # Count files that have been scanned (lines ending with OK or FOUND)
            SCANNED_COUNT=$(grep -E "(: OK|FOUND)" "$TEMP_SCAN_LOG" 2>/dev/null | wc -l)
        fi
        
        # Calculate percentage
        if [ "$FILE_COUNT" -gt 0 ]; then
            PERCENTAGE=$((SCANNED_COUNT * 100 / FILE_COUNT))
            
            # Cap at 99% until scan is complete
            if [ "$PERCENTAGE" -gt 99 ]; then
                PERCENTAGE=99
            fi
            
            # Update LCD only if percentage changed (to avoid flickering)
            if [ "$PERCENTAGE" != "$LAST_PERCENTAGE" ]; then
                display_on_lcd "Scanning..." "$PERCENTAGE%"
                echo -ne "\rProgress: $PERCENTAGE% ($SCANNED_COUNT/$FILE_COUNT files)"
                LAST_PERCENTAGE=$PERCENTAGE
            fi
        fi
        
        sleep 0.3
    done
    
    # Wait for clamscan to complete
    wait $CLAMSCAN_PID
    SCAN_EXIT_CODE=$?
    
    # Show 100% when done
    display_on_lcd "Scanning..." "100%"
    echo -e "\n${GREEN}Scan complete!${NC}"
    sleep 1
    
    # Read scan results
    SCAN_RESULT=$(cat "$TEMP_SCAN_OUTPUT")
    
    # Parse scan results from the summary
    INFECTED_FILES=$(echo "$SCAN_RESULT" | grep "Infected files:" | awk '{print $3}')
    SCANNED_FILES=$(echo "$SCAN_RESULT" | grep "Scanned files:" | awk '{print $3}')
    
    # If parsing failed, try alternative method
    if [ -z "$INFECTED_FILES" ]; then
        INFECTED_FILES=$(grep -c "FOUND" "$TEMP_SCAN_OUTPUT")
    fi
    if [ -z "$SCANNED_FILES" ]; then
        SCANNED_FILES=$SCANNED_COUNT
    fi
    
    echo "Scanned files: $SCANNED_FILES"
    echo "Infected files: $INFECTED_FILES"
    
    log_message "Scan complete - Scanned: $SCANNED_FILES, Infected: $INFECTED_FILES"
    
    # Extract infected file names
    grep "FOUND" "$TEMP_SCAN_OUTPUT" > "$TEMP_INFECTED_FILES"
    
    # Display results
    if [ "$INFECTED_FILES" = "0" ] || [ -z "$INFECTED_FILES" ]; then
        echo -e "${GREEN}No malware detected!${NC}"
        display_on_lcd "Scan complete" "Clean!"
        log_message "Result: CLEAN"
        sleep 3
        display_on_lcd "Safe to use" "No threats"
    else
        echo -e "${RED}WARNING: $INFECTED_FILES infected file(s) found!${NC}"
        display_on_lcd "WARNING!" "$INFECTED_FILES threats"
        log_message "Result: INFECTED - $INFECTED_FILES threat(s) found"
        sleep 3
        
        # Display each infected file on LCD
        while IFS= read -r line; do
            # Extract filename and malware name
            # Line format: /path/to/file: malware.name FOUND
            FULL_PATH=$(echo "$line" | sed 's/:.*//')
            INFECTED_FILE=$(basename "$FULL_PATH")
            MALWARE_NAME=$(echo "$line" | sed 's/.*: //' | sed 's/ FOUND//')
            
            echo -e "${RED}Infected: $INFECTED_FILE${NC}"
            echo -e "${RED}Malware: $MALWARE_NAME${NC}"
            
            # Display filename (truncated to 16 chars)
            display_on_lcd "Infected file:" "${INFECTED_FILE:0:16}"
            sleep 3
            
            # Display malware name (truncated to 16 chars)
            display_on_lcd "Malware type:" "${MALWARE_NAME:0:16}"
            sleep 3
            
        done < "$TEMP_INFECTED_FILES"
        
        # Final warning
        display_on_lcd "DO NOT USE" "Infected USB!"
        
        # Log infected files
        cat "$TEMP_INFECTED_FILES" | tee -a "$SCAN_LOG"
    fi
    
    # Save full scan report
    echo "$SCAN_RESULT" >> "$SCAN_LOG"
    echo "----------------------------------------" >> "$SCAN_LOG"
    
    # Cleanup temp files
    rm -f "$TEMP_SCAN_OUTPUT" "$TEMP_SCAN_LOG" "$TEMP_INFECTED_FILES"
    
    # Unmount
    sleep 2
    echo "Unmounting device..."
    sudo umount "$MOUNT_POINT"
    sudo rmdir "$MOUNT_POINT"
    log_message "Device unmounted"
    
else
    echo -e "${RED}Failed to mount /dev/${DEVICE}1${NC}"
    display_on_lcd "Mount failed" "Cannot scan"
    log_message "ERROR: Failed to mount device"
    sleep 3
    exit 1
fi

echo -e "${GREEN}=== Analysis Complete ===${NC}"
log_message "Malware scan completed for /dev/$DEVICE"
